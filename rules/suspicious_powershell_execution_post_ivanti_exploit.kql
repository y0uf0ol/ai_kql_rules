// Suspicious PowerShell Execution Post Ivanti Exploit
// Note: This is an AI Generated Rule use with caution
// https://unit42.paloaltonetworks.com/threat-brief-ivanti-cve-2023-46805-cve-2024-21887/
// MITRE Tactic and Technique: Execution, T1059.001 - PowerShell
DeviceProcessEvents
| where ProcessCommandLine has "powershell" or ProcessCommandLine has "pwsh"
| where ProcessCommandLine has_any("Net.WebClient", "DownloadFile", "IEX", "Invoke-Expression", "Start-Process")
| summarize SuspiciousPowerShellUsage=count(), AffectedDevices=dcount(DeviceId) by ProcessCommandLine, DeviceId, InitiatingProcessFileName
| where SuspiciousPowerShellUsage > 0